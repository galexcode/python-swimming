
## Specified configuration ##

SRCDIR=./src
DESTDIR=.

INCLUDES=-I$(PYTHONAPI) -I.$(NPAPI)

TESTS=embedded basicplugin embedded_bytecode

## Automatic tests ##

all: $(TESTS)
	./embedded.bin
	./embedded_bytecode.bin
	echo [OK] Automatic tests	

## Tests ##

embedded: embedded.bin
	echo [OK] Compiled embedded

basicplugin: basicplugin.so
	echo [OK] Compiled basic plugin

embedded_bytecode: embedded_bytecode.bin embedded_bytecode.pyc
	echo [OK] Compiled embedded bytecode

## Rules ##

%.o: $(SRCDIR)/%.c
	$(CC) $(GFLAGS) $(CFLAGS) $(INCLUDES) -c $^ -o $@
	echo [OK] Compiled $@

%.bin: %.o
	$(CC) $^ $(LDFLAGS) -o $@
	echo [OK] Compiled $@

%.so: %.o
	$(CC) $(CFLAGS) -shared $^ $(LDFLAGS) -o $@
	echo [OK] Compiled $@

%.pyc: $(SRCDIR)/%.py
	../src/generate_bytecode.py $^
	mv $(SRCDIR)/$@ ./$@
	echo [OK] Generated bytecode $@

## Other ##

.PHONY: clean all $(TESTS)

.SILENT:

clean:
	$(RM) -f *.o *~ \#*
	cd $(SRCDIR) && $(RM) -f *.o *~ \#*

