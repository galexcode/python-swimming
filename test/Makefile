##########################################################################
## Makefile to build the software tests.                                ##
##                                                                      ##
## Python swimming Copyright (C) 2012 Jesús Hernández Gormaz            ##
## This program is free software; you can redistribute it and/or        ##
##  modify it under the terms of the GNU General Public License as      ##
##  published by the Free Software Foundation; either version 3, or     ##
##  (at your option) any later version.                                 ##
## This program is distributed in the hope that it will be useful,      ##
##  but WITHOUT ANY WARRANTY; without even the implied warranty of      ##
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the        ##
##  GNU General Public License for more details.                        ##
## You should have received a copy of the GNU General Public License    ##
##  along with this program; if not, write to the Free Software         ##
##  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.           ##
##########################################################################

## Specified configuration ##
SRCDIR=./src
DESTDIR=.

INCLUDES=-I$(PYTHONAPI) -I.$(NPAPI)

TESTS=basicplugin embedded embedded_bytecode pure_embedding

FDATE=date +%X

## Automatic tests ##
all: pre_tests $(TESTS)
	echo [`$(FDATE)`] Start automatic tests:
	./embedded.bin
	echo [`$(FDATE)`]
	./embedded_bytecode.bin
	echo [`$(FDATE)`] Finish tests.

## Actions before the tests ##
pre_tests:
	echo [`$(FDATE)`] Start tests:

## Tests ##
basicplugin: basicplugin.so
	echo [`$(FDATE)`] Compiled basic plugin

embedded: embedded.bin
	echo [`$(FDATE)`] Compiled embedded

embedded_bytecode: embedded_bytecode.bin embedded_bytecode.pyc
	echo [`$(FDATE)`] Compiled embedded bytecode

pure_embedding: pure_embedding.bin
	echo [`$(FDATE)`] Compiled pure embedding

## Rules ##
%.o: $(SRCDIR)/%.c
	$(CC) $(GFLAGS) $(CFLAGS) $(INCLUDES) -c $^ -o $@
	echo [OK] Compiled $@

%.bin: %.o
	$(CC) $^ $(LDFLAGS) -o $@
	echo [OK] Compiled $@

%.so: %.o
	$(CC) $(CFLAGS) -shared $^ $(LDFLAGS) -o $@
	echo [OK] Compiled $@

%.pyc: $(SRCDIR)/%.py
	../src/generate_bytecode.py $^
	mv $(SRCDIR)/$@ ./$@
	echo [OK] Generated bytecode $@

## Other ##
.PHONY: clean testclean all $(TESTS) pre_tests

.SILENT:

clean:
	$(RM) -f *.o *~ \#*
	cd $(SRCDIR) && $(RM) -f *.o *~ \#*

testclean:
	$(RM) -f *.bin *.pyc *.so *.py
	echo Delete tests

